{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>NexSafe - Smart Road Safety</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="manifest" href="{% static 'manifest.json' %}">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <style>
        body {
            font-family: 'Roboto', sans-serif;
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .header {
            background: #0b3d91;
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .metric {
            font-size: 1.2em;
            margin: 10px 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .metric-value {
            font-weight: 500;
        }
        .safe { color: #2ecc71; }
        .warning { color: #e67e22; }
        .danger { color: #e74c3c; }
        #map {
            height: 200px;
            border-radius: 10px;
            margin-bottom: 15px;
        }
        .start-btn {
            width: 100%;
            padding: 12px;
            background: #0b3d91;
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            margin: 10px 0;
            cursor: pointer;
            transition: background 0.3s;
        }
        .start-btn:hover {
            background: #0a2d6d;
        }
        .start-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .loading {
            opacity: 0.7;
        }
    </style>
</head>
<body>
    <div class="header">
        <h2>ðŸš— NexSafe</h2>
        <p>AI-Powered Road Safety Monitor</p>
    </div>

  <div class="card">
    <h3>Real-time Metrics</h3>
    <button id="startMonitoring" class="start-btn">Start Monitoring</button>
    <div class="metric">
      <span>Speed:</span>
      <span id="speed" class="metric-value">0 km/h</span>
    </div>
    <div class="metric">
      <span>Status:</span>
      <span id="status" class="metric-value safe">Ready</span>
    </div>
    <div class="metric">
      <span>Behavior:</span>
      <span id="behavior" class="metric-value">Waiting to start...</span>
    </div>
  </div>

  <div class="card">
    <h3>Location & Conditions</h3>
    <div id="map"></div>
    <div class="metric">
      <span>Road Type:</span>
      <span id="road-type" class="metric-value">-</span>
    </div>
    <div class="metric">
      <span>Weather:</span>
      <span id="weather" class="metric-value">-</span>
    </div>
  </div>

      <script>
        // Initialize variables
        let map, marker;
        let lastPrediction = "";
        let speedHistory = [];
        let watchId = null;

        // Initialize Google Maps API
        (g=>{var h,a,k,p="The Google Maps JavaScript API",c="google",l="importLibrary",q="__ib__",m=document,b=window;b=b[c]||(b[c]={});var d=b.maps||(b.maps={}),r=new Set,e=new URLSearchParams,u=()=>h||(h=new Promise(async(f,n)=>{await (a=m.createElement("script"));e.set("libraries",[...r]+"");for(k in g)e.set(k.replace(/[A-Z]/g,t=>"_"+t[0].toLowerCase()),g[k]);e.set("callback",c+".maps."+q);a.src=`https://maps.${c}apis.com/maps/api/js?`+e;d[q]=f;a.onerror=()=>h=n(Error(p+" could not load."));a.nonce=m.querySelector("script[nonce]")?.nonce||"";m.head.append(a)}));d[l]?console.warn(p+" only loads once. Ignoring:",g):d[l]=(f,...n)=>r.add(f)&&u().then(()=>d[l](f,...n))})({
            key: "AIzaSyB41DRUbKWJHPxaFjMAwdrzWzbVKartNGg",
            v: "weekly"
        });

        // Initialize map
        

        function initMap() {
            map = L.map('map').setView([20.5937, 78.9629], 6);

            // Use free OSM tile layer
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: 'Â© OpenStreetMap contributors'
            }).addTo(map);

            marker = L.marker([20.5937, 78.9629]).addTo(map);
        }

        // Update marker position
        function updatePosition(lat, lng) {
            if (marker) {
                marker.setLatLng([lat, lng]);
                map.setView([lat, lng], 15);
            }
        }


        // Assess driver behavior based on speed and acceleration
        function assessDriverBehavior(speed, acceleration) {
            if (speed > 80) return { status: "danger", message: "Overspeeding" };
            if (Math.abs(acceleration) > 3) return { status: "warning", message: "Sudden Movement" };
            return { status: "safe", message: "Normal Driving" };
        }

        // Initialize map when the page loads
        document.addEventListener('DOMContentLoaded', initMap);

        // Start monitoring button click handler
        document.getElementById('startMonitoring').addEventListener('click', async function() {
            if (!watchId && 'geolocation' in navigator) {
                this.textContent = 'Monitoring Active...';
                this.disabled = true;
                this.classList.add('loading');

                // Ensure map is initialized
                if (!map) {
                    const mapReady = await initMap();
                    if (!mapReady) {
                        alert("Error initializing map. Please refresh the page.");
                        return;
                    }
                }

                watchId = navigator.geolocation.watchPosition(
                    // Success callback
                    pos => {
                        const speed = pos.coords.speed || 0;
                        const speedKmh = speed * 3.6;
                
                        // Update speed history
                        speedHistory.push(speedKmh);
                        if (speedHistory.length > 10) speedHistory.shift();
                
                        // Calculate acceleration
                        const acceleration = speedHistory.length > 1 ? 
                            (speedHistory[speedHistory.length-1] - speedHistory[speedHistory.length-2]) / 3.6 : 0;
                
                        // Assess behavior
                        const behavior = assessDriverBehavior(speedKmh, acceleration);

                        // Update map
                                try {
                                    if (map && marker) {
                                        const position = { lat: pos.coords.latitude, lng: pos.coords.longitude };
                                        updatePosition(position.lat, position.lng);

                                        
                                    } else {
                                        console.warn('Map or marker not ready yet. Skipping position update.');
                                    }
                                } catch (err) {
                                    console.error('Error updating map/marker position:', err);
                                    // If the Maps API failed to authorize, you'll see RefererNotAllowedMapError in the console.
                                    // That must be fixed in Google Cloud Console by allowing this origin as an HTTP referrer.
                                }

                        // Send data to backend
                        fetch("/predict/", {
                            method: "POST",
                            headers: {
                                "Content-Type": "application/x-www-form-urlencoded",
                                "X-CSRFToken": document.cookie.split('; ').find(row => row.startsWith('csrftoken=')).split('=')[1]
                            },
                            body: new URLSearchParams({
                                speed: speedKmh,
                                vehicles: 1,
                                casualties: 0,
                                day: new Date().getDay(),
                                light: new Date().getHours() >= 6 && new Date().getHours() < 18 ? 1 : 0,
                                weather: 1,
                                surface: 1,
                                urban: 1
                            })
                        })
                        .then(res => res.json())
                        .then(data => {
                            // Update UI
                            const speedClass = speedKmh > 80 ? 'danger' : speedKmh > 60 ? 'warning' : 'safe';
                            document.getElementById("speed").className = `metric-value ${speedClass}`;
                            document.getElementById("speed").textContent = `${speedKmh.toFixed(1)} km/h`;
                
                            document.getElementById("status").className = `metric-value ${data.prediction === 1 ? 'danger' : 'safe'}`;
                            document.getElementById("status").textContent = data.prediction === 1 ? 'ðŸš¨ High Risk' : 'âœ… Safe';
                
                            document.getElementById("behavior").className = `metric-value ${behavior.status}`;
                            document.getElementById("behavior").textContent = behavior.message;
                        })
                        .catch(err => console.error('Prediction error:', err));

                        // Update road conditions (simulated)
                        const roadTypes = ['Urban', 'Highway', 'Rural'];
                        document.getElementById("road-type").textContent = roadTypes[Math.floor(Math.random() * roadTypes.length)];
                    },
                    // Error callback
                    err => {
                        console.error('Geolocation error:', err);
                        this.textContent = 'Start Monitoring';
                        this.disabled = false;
                        this.classList.remove('loading');
                        alert("Please enable location services for accurate monitoring");
                    },
                    // Options
                    {
                        enableHighAccuracy: true,
                        maximumAge: 0
                    }
                );
            }
        });
      </script>
</html>
